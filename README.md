# 🎥 ДОПРОС MVP 2.0

## Система интеллектуального анализа видео допросов с мультимодальным распознаванием эмоций

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://python.org)
[![Streamlit](https://img.shields.io/badge/Streamlit-1.28+-red.svg)](https://streamlit.io)
[![YOLO](https://img.shields.io/badge/YOLO-v11-green.svg)](https://github.com/ultralytics/ultralytics)
[![OpenAI](https://img.shields.io/badge/OpenAI-Whisper-orange.svg)](https://openai.com/research/whisper)

**ДОПРОС MVP 2.0** — это передовая система анализа видео допросов, использующая искусственный интеллект для выявления эмоциональных паттернов, критических моментов и психологических индикаторов в поведении допрашиваемых.

---

## ✨ Ключевые возможности

### 🧠 **Мультимодальный анализ эмоций**
- **Видео анализ**: Распознавание эмоций по мимике с помощью YOLO11, FER, DeepFace
- **Анализ речи**: Обработка аудио с Whisper и анализ эмоций в голосе
- **Синхронизация**: Корреляция эмоций между видео и аудио дорожками

### 🔄 **Анализ переходов эмоций** (NEW!)
- **Детекция критических паттернов**: спокойствие→злость, нейтральность→страх
- **Психологические индикаторы**: вероятность лжи, уровень стресса, эмоциональный контроль
- **Индекс нестабильности**: от "стабильное состояние" до "критическая нестабильность"
- **141 переход** обнаружено в тестах, **3 критических паттерна** выявлено

### 📊 **Интеллектуальная аналитика**
- **Критические моменты**: Автоматическое выявление подозрительного поведения
- **Временная шкала**: Визуализация эмоциональных изменений во времени
- **Тепловые карты**: Интенсивность эмоций по времени
- **Психологический профиль**: Детальный анализ поведенческих паттернов

### 🎯 **Практическое применение**
- **Следственные органы**: Помощь в выявлении ложных показаний
- **Психологи**: Анализ эмоционального состояния
- **Юристы**: Оценка достоверности свидетельских показаний
- **Исследователи**: Изучение поведенческих паттернов

---

## 🏗️ Архитектура системы

```
ДОПРОС MVP 2.0
├── 🎬 Загрузка видео → 🖼️ Извлечение кадров → 👤 Детекция лиц
├── 🧠 Анализ эмоций → 🎵 Извлечение аудио → 🗣️ Транскрипция
├── 📈 Анализ речи → 🔄 Анализ переходов → ⚠️ Критические моменты  
└── 📊 Генерация отчетов → 📱 Streamlit UI
```

### **13 этапов обработки:**
1. **validate_input** - Валидация входного видео
2. **setup_session** - Настройка сессии
3. **extract_frames** - Извлечение кадров
4. **detect_faces** - Детекция лиц (YOLO11)
5. **analyze_emotions** - Анализ эмоций лица (FER/DeepFace)
6. **extract_audio** - Извлечение аудио дорожки
7. **transcribe_audio** - Транскрипция речи (Whisper)
8. **analyze_speech** - Анализ эмоций в речи
9. **synchronize_data** - Синхронизация модальностей
10. **analyze_transitions** - 🆕 **Анализ переходов эмоций**
11. **detect_critical** - Поиск критических моментов
12. **generate_insights** - Генерация инсайтов (GPT-4)
13. **create_reports** - Создание отчетов

---

## 🔄 Система анализа переходов эмоций

### **Критические паттерны переходов:**

```python
CRITICAL_TRANSITIONS = {
    # Признаки стресса/лжи
    "спокойствие → злость": {"severity": 9, "type": "агрессивная защита"},
    "нейтральность → страх": {"severity": 8, "type": "внезапная тревога"},
    "счастье → грусть": {"severity": 7, "type": "эмоциональный срыв"},
    
    # Признаки сокрытия
    "злость → спокойствие": {"severity": 8, "type": "подавление эмоций"},
    "страх → нейтральность": {"severity": 7, "type": "маскировка тревоги"},
    
    # Манипулятивные паттерны
    "грусть → счастье": {"severity": 6, "type": "неконгруэнтность"},
    "злость → счастье": {"severity": 7, "type": "резкая смена"}
}
```

### **Психологические индикаторы:**
- **🎭 Вероятность лжи**: Анализ подозрительных переходов
- **⚡ Уровень стресса**: Оценка эмоционального напряжения  
- **🎯 Эмоциональный контроль**: Способность управлять эмоциями
- **🌡️ Индекс нестабильности**: Общая эмоциональная изменчивость

### **Результаты анализа:**
```
🔄 Всего переходов: 141
⚠️ Критических: 3  
🎥 Видео: 141 | 🎙️ Речь: 0

Критические паттерны:
• нейтральность → страх (внезапная тревога) - 8/10 критичность
• Временные метки: 236.9с, 333.6с, 519.3с
• Скорость: быстрый переход (~0.97с)
```

---

## 🚀 Быстрый старт

### **1. Установка зависимостей**

```bash
# Клонирование репозитория
git clone https://github.com/YergZakon/dopros.git
cd dopros

# Установка зависимостей
pip install -r requirements.txt

# Установка дополнительных пакетов для анализа переходов
pip install ultralytics opencv-python fer deepface openai-whisper
```

### **2. Настройка API ключей**

```bash
# Создайте .env файл
echo "OPENAI_API_KEY=your_openai_api_key_here" > .env
```

### **3. Запуск приложения**

```bash
streamlit run main.py
```

Перейдите на http://localhost:8501

### **4. Использование**

1. **📁 Загрузка**: Загрузите видео файл или выберите демо режим
2. **⚙️ Настройка**: Выберите модели анализа и параметры
3. **🚀 Анализ**: Запустите полный анализ (13 этапов)
4. **📊 Результаты**: Изучите эмоции, переходы и критические моменты
5. **🎙️ Речевой анализ**: Просмотрите анализ аудио и транскрипцию
6. **📋 Отчеты**: Получите детальные отчеты и инсайты

---

## 📊 Интерфейс системы

### **Главные вкладки:**

#### 🏠 **Загрузка и настройка**
- Загрузка видео файлов (MP4, AVI, MOV)
- Демо режим с тестовыми данными
- Настройка моделей и параметров анализа
- Контроль процесса обработки

#### 📊 **Анализ эмоций**
```
📈 Основные показатели
🎭 Доминирующая эмоция | 🔄 Изменения эмоций | ⚡ Уровень стресса | ⚖️ Стабильность

🔄 Анализ переходов эмоций
🔄 Всего переходов | ⚠️ Критических | 🎥 Видео | 🎙️ Речь

⚠️ Критические паттерны
▼ Паттерн 1: нейтральность → страх
  📍 Время: 236.9с | 📺 Модальность: video | 🏷️ Тип: внезапная тревога
  🎯 Критичность: 8/10 | ⚡ Скорость: быстрый | ⏱️ Длительность: 0.97с

📊 Детальные метрики
🌡️ Индекс эмоциональной нестабильности: 0.213 (умеренная изменчивость)
```

#### 🎙️ **Анализ речи**
- Временная шкала эмоций в речи
- Аудио плеер с синхронизацией
- Характеристики речи и пауз
- Транскрипция с эмоциональными метками

#### 📋 **Отчеты и инсайты**
- Критические моменты допроса
- Психологический анализ (GPT-4)
- Рекомендации для следователей
- Экспорт в различные форматы

---

## ⚙️ Конфигурация

### **config.yaml - основные настройки:**

```yaml
# Обработка видео
processing:
  video:
    frame_skip: 15        # Каждый N-й кадр
    min_frames: 10        # Минимум кадров
    max_resolution: [1920, 1080]

# Модели ИИ
models:
  yolo:
    models:
      detection: "yolo11n.pt"
      face: "yolo11n.pt" 
      emotion: "yolo11n.pt"
    confidence_threshold: 0.5
    
  whisper:
    model_size: "base"    # base, small, medium, large
    language: "ru"
    
  gpt:
    model: "gpt-4-turbo-preview"
    max_tokens: 4000

# Анализ переходов эмоций (NEW!)
transitions:
  min_transition_duration: 0.3
  confidence_threshold: 0.3
  enable_critical_detection: true
  critical_severity_threshold: 7
  
  psychological_analysis:
    enable_deception_detection: true
    enable_stress_analysis: true
    enable_control_assessment: true
    enable_instability_tracking: true
```

---

## 🧪 Тестирование

### **Запуск юнит-тестов:**

```bash
# Тесты системы переходов эмоций
python test_emotion_transitions.py

# Интеграционные тесты
python test_transitions_pipeline.py

# Тест графиков речи
python test_speech_emotion_plot.py
```

### **Результаты тестов:**

```
🧪 Тестирование EmotionTransitionDetector
✅ 15 юнит-тестов прошли успешно
✅ Интеграционные тесты: 14 переходов, 1 критический
✅ JSON сериализация работает
✅ Психологические индикаторы: 4 показателя
```

---

## 🛠️ Технологический стек

### **Backend:**
- **Python 3.8+** - Основной язык
- **OpenCV** - Обработка видео
- **YOLO11** - Детекция лиц и объектов
- **FER/DeepFace** - Анализ эмоций лица
- **OpenAI Whisper** - Транскрипция речи
- **SpeechRecognition** - Анализ эмоций в голосе

### **Frontend:**
- **Streamlit** - Веб-интерфейс
- **Plotly** - Интерактивные графики
- **Pandas** - Обработка данных

### **AI/ML:**
- **OpenAI GPT-4** - Генерация инсайтов
- **PyTorch/TensorFlow** - Нейронные сети
- **Librosa** - Анализ аудио
- **NumPy/SciPy** - Численные вычисления

### **Infrastructure:**
- **Docker** (готовится) - Контейнеризация
- **GPU Support** - CUDA/RTX оптимизация
- **Cache System** - Кеширование результатов

---

## 📁 Структура проекта

```
dopros/
├── 📄 main.py                          # Главное Streamlit приложение
├── ⚙️ config.yaml                      # Конфигурация системы
├── 📋 requirements.txt                  # Зависимости Python
│
├── 🧠 core/                            # Основная логика
│   ├── pipeline.py                     # Главный пайплайн обработки
│   ├── emotion_analyzer.py             # Анализ эмоций
│   ├── audio_processor.py              # Обработка аудио
│   └── report_generator.py             # Генерация отчетов
│
├── 🔄 emotion_transition_analyzer/      # 🆕 Анализ переходов эмоций
│   ├── __init__.py                     # Инициализация модуля
│   ├── transition_detector.py          # Детектор переходов
│   └── transition_metrics.py           # Метрики и психология
│
├── 🤖 models/                          # AI модели
│   ├── yolo_manager.py                 # Управление YOLO
│   └── speech_analyzer.py              # Анализ речи
│
├── 🔧 utils/                           # Утилиты
│   ├── gpu_manager.py                  # Управление GPU
│   └── json_utils.py                   # JSON сериализация
│
├── 🔗 integrations/                    # Интеграции
│   └── openai_client.py                # OpenAI API
│
├── 🧪 tests/                           # Тесты
│   ├── test_emotion_transitions.py     # Тесты переходов
│   └── test_transitions_pipeline.py    # Интеграционные тесты
│
└── 📊 storage/                         # Данные и кеш
    ├── videos/                         # Загруженные видео
    ├── frames/                         # Извлеченные кадры
    ├── audio/                          # Аудио файлы
    └── results/                        # Результаты анализа
```

---

## 🔍 Примеры использования

### **1. Базовый анализ видео**

```python
from core.pipeline import MasterPipeline

# Инициализация пайплайна
pipeline = MasterPipeline('config.yaml')

# Анализ видео
results = pipeline.process_video('path/to/video.mp4')

# Получение результатов
emotions = results['data']['video_emotions']
transitions = results['data']['analyze_transitions']
critical_moments = results['data']['critical_moments']
```

### **2. Анализ переходов эмоций**

```python
from emotion_transition_analyzer import EmotionTransitionDetector, TransitionMetricsCalculator

# Инициализация детектора
detector = EmotionTransitionDetector()
calculator = TransitionMetricsCalculator()

# Детекция переходов
video_transitions = detector.detect_transitions(video_emotions, 'video')
speech_transitions = detector.detect_transitions(speech_emotions, 'speech')

# Расчет метрик
metrics = calculator.calculate_comprehensive_metrics(
    video_transitions, speech_transitions
)

# Критические паттерны
critical_patterns = [t for t in video_transitions if t.is_critical]
```

### **3. Психологический анализ**

```python
# Получение психологических индикаторов
psychology = metrics['psychological_indicators']['combined']

print(f"Вероятность лжи: {psychology['deception_likelihood']:.2%}")
print(f"Уровень стресса: {psychology['stress_level']:.2%}")
print(f"Эмоциональный контроль: {psychology['emotional_control']:.2%}")

# Индекс нестабильности
instability = metrics['instability_index']
print(f"Нестабильность: {instability['combined_instability']:.3f}")
print(f"Интерпретация: {instability['interpretation']}")
```

---

## 📈 Производительность

### **Системные требования:**
- **CPU**: Intel i5+ или AMD Ryzen 5+
- **RAM**: 8GB+ (рекомендуется 16GB)
- **GPU**: NVIDIA RTX (опционально, для ускорения)
- **Диск**: 10GB свободного места
- **Python**: 3.8+

### **Время обработки:**
- **2-минутное видео**: ~45-60 секунд
- **10-минутное видео**: ~3-5 минут
- **С GPU**: ускорение в 2-3 раза

### **Оптимизации:**
- Параллельная обработка кадров
- Кеширование результатов
- Адаптивное качество анализа
- GPU ускорение (CUDA/RTX)

---

## 🤝 Участие в разработке

### **Как внести вклад:**

1. **Fork** репозитория
2. Создайте **feature branch** (`git checkout -b feature/amazing-feature`)
3. **Commit** изменения (`git commit -m 'Add amazing feature'`)
4. **Push** в branch (`git push origin feature/amazing-feature`)
5. Откройте **Pull Request**

### **Области для улучшения:**
- 🎯 Новые психологические паттерны
- 🌍 Мультиязычная поддержка  
- 📱 Мобильная версия
- 🔊 Улучшение анализа речи
- 📊 Дополнительные метрики
- 🚀 Docker контейнеризация

---

## 📄 Лицензия

Этот проект распространяется под лицензией **MIT License**. См. файл [LICENSE](LICENSE) для подробностей.

---

## 👥 Авторы

- **YergZakon** - *Основной разработчик* - [GitHub](https://github.com/YergZakon)
- **Claude Code** - *AI Assistant* - Помощь в разработке системы переходов эмоций

---

## 📞 Поддержка

### **Есть вопросы?**
- 📧 **Email**: [создайте Issue](https://github.com/YergZakon/dopros/issues)
- 💬 **Discussions**: [GitHub Discussions](https://github.com/YergZakon/dopros/discussions)
- 🐛 **Bugs**: [Issue Tracker](https://github.com/YergZakon/dopros/issues)

### **Полезные ссылки:**
- 📖 [Документация API](docs/API.md)
- 🎓 [Руководство пользователя](docs/USER_GUIDE.md)
- 🔧 [Руководство по разработке](docs/DEVELOPMENT.md)
- 📊 [Примеры использования](examples/)

---

## 🎯 Roadmap

### **v2.1 (В разработке)**
- [ ] 🌍 Поддержка английского языка
- [ ] 📱 Мобильная версия интерфейса
- [ ] 🔊 Улучшенный анализ тона голоса
- [ ] 📊 Экспорт в Excel/PDF

### **v2.2 (Планируется)**
- [ ] 🤖 Интеграция с GPT-4V для анализа видео
- [ ] 👥 Анализ групповых допросов
- [ ] 📈 Real-time анализ
- [ ] 🔒 Продвинутое шифрование данных

### **v3.0 (Будущее)**
- [ ] 🧠 Нейронные сети для предсказания поведения
- [ ] 🌐 Веб-версия без установки
- [ ] 📱 Мобильные приложения (iOS/Android)
- [ ] 🏢 Корпоративная версия

---

<div align="center">

## ⭐ Если проект вам помог - поставьте звездочку!

### 🔄 **ДОПРОС MVP 2.0** - *Будущее анализа допросов уже здесь*

**[⬆️ Наверх](#-допрос-mvp-20)**

---

*Создано с ❤️ для повышения эффективности следственной работы*

**Generated with [Claude Code](https://claude.ai/code)**

</div>